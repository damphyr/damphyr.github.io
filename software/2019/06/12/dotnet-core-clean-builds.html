<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="google-site-verification" content="WJoG1y4O1QfZDWU4OFY1tGfE75UXU6WmQc91gCSLY5g" />
  <title>Out-of-band DotNet core</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="alternate" type="application/rss+xml" title="Ampelofilosofies" href="http://www.ampelofilosofies.gr/feed.xml">

  <!-- syntax highlighting CSS -->
  <link rel="stylesheet" href="/css/syntax.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/main.css">
</head>

<body>

  <div class="container">
    <div class="site">
      <div class="header">
        <h1 class="title"><a href="/">Ampelofilosofies</a></h1>
        <a class="extra" href="/">home</a><a class="extra" href="/about.html">about</a><a class="extra"
          href="/feed.xml">rss</a>
        <br />
        <span class="extra">The mind is like a parachute. If it doesn't open, you're meat.</span>
      </div>

      <h1>Out-of-band DotNet core</h1>
<p class="meta">12 Jun 2019</p>

<div class="post"><p><em>This entry was edited again on 2019-09-04 and updated so that no more project file entries are necessary</em>.
I am a proponent of “out-of-band” builds. This simply means that any and all files generated by the build process should not under any circumstances be found next to sources.</p>

<p>The simplest check for this is doing a <code class="language-plaintext highlighter-rouge">git status</code> after building and seeing no untracked files, provided your .gitignore is (almost) empty.</p>

<p>Correspondingly I find long .gitignore files simply annoying and an indication of sloppy development practices.</p>

<p>This is a long saga, there are <a href="/software/2016/02/16/damn-you-vs">rant entries</a> in this blog from way back in 2016.</p>

<p>Visual Studio was my greatest adversary in the quest for clean workspaces…until DotNet core came out.</p>

<p>Previously in the saga we figured out how to get the intermediate <em>compilation</em> results out of the way by setting <code class="language-plaintext highlighter-rouge">&lt;IntermediateOutputPath&gt;</code>.</p>

<p>But dotnet does not respect this property. It uses instead <code class="language-plaintext highlighter-rouge">&lt;BaseIntermediateOutputPath&gt;</code>. Things like nuget specs and package assets (properties and tasks for nuget packages etc.) will land in this directory.</p>

<p>OK, you say, I’ll set that in the project file and be done. And then you spent a couple of hours trying to figure out why the setting is not respected.</p>

<p>It all has to do with the way msbuild defines properties and figuring out which property to use and when it is defined.</p>

<p>See, in the drive to have everything “just work” when you create a dotnet core project in Visual Studio the project element will have a magic <em>Sdk</em> attribute:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Project</span> <span class="na">Sdk=</span><span class="s">"Microsoft.NET.Sdk"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/Project&gt;</span>
</code></pre></div></div>

<p>This, very slyly, instructs msbuild to import a whole bunch of property and task files. No need for you to know all the dirty details, innit?</p>

<p>And if you try to override it late, you will get a nice warning</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\Program</span><span class="w"> </span><span class="nx">Files\dotnet\sdk\2.2.300\Microsoft.Common.CurrentVersion.targets</span><span class="p">(</span><span class="mi">813</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span><span class="w"> </span><span class="n">warning</span><span class="w"> </span><span class="nx">MSB3539:</span><span class="w">
</span><span class="n">The</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">property</span><span class="w"> </span><span class="s2">"BaseIntermediateOutputPath"</span><span class="w"> </span><span class="nx">was</span><span class="w"> </span><span class="nx">modified</span><span class="w"> </span><span class="nx">after</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="nx">was</span><span class="w"> </span><span class="nx">used</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">MSBuild</span><span class="w">
</span><span class="n">which</span><span class="w"> </span><span class="nx">can</span><span class="w"> </span><span class="nx">lead</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">unexpected</span><span class="w"> </span><span class="nx">build</span><span class="w"> </span><span class="nx">results.</span><span class="w">
</span><span class="n">Tools</span><span class="w"> </span><span class="nx">such</span><span class="w"> </span><span class="nx">as</span><span class="w"> </span><span class="nx">NuGet</span><span class="w"> </span><span class="nx">will</span><span class="w"> </span><span class="nx">write</span><span class="w"> </span><span class="nx">outputs</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="nx">specified</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="s2">"MSBuildProjectExtensionsPath"</span><span class="w"> </span><span class="nx">instead.</span><span class="w">
</span><span class="n">To</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">property</span><span class="p">,</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">must</span><span class="w"> </span><span class="nx">do</span><span class="w"> </span><span class="nx">so</span><span class="w"> </span><span class="nx">before</span><span class="w"> </span><span class="nx">Microsoft.Common.props</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">imported</span><span class="p">,</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">example</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">using</span><span class="w">
</span><span class="n">Directory.Build.props.</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Directory.Build.props</code> is one of those “magic” files. It is loaded very early and you can set these properties there. It will get picked up if it is there and msbuild will search far and wide for it (it will go up the directory tree and then look in a few places more).</p>

<h2 id="not-that-simple">Not that simple</h2>

<p>Timing is everything it seems. There are things you cannot put in <code class="language-plaintext highlighter-rouge">Directory.Build.props</code>. For example, the <em>AssemblyName</em> property is not set yet when the file is processed, so we cannot really set <em>OutputPath</em> and <em>IntermediateOutputPath</em> to safely differentiate compilation artifacts.</p>

<p>The one thing we learned the hard way: Always add <code class="language-plaintext highlighter-rouge">$(Configuration)</code>somewhere in the path otherwise you will get very wierd results (as in “honey, I linked the wrong binaries”).</p>

<p>To be able to use property values that are set later, use <code class="language-plaintext highlighter-rouge">Directory.Build.targets</code> which is read after msbuild has loaded its task files.</p>

<p>So we split the difference</p>

<p><code class="language-plaintext highlighter-rouge">Directory.Build.props</code> is very basic, as follows:</p>

<pre><code class="language-`xml">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003"&gt;
  &lt;PropertyGroup&gt;
    &lt;BaseOutputPath&gt;$(MSBuildThisFileDirectory)\..\..\out\build\$(MSBuildProjectName)\&lt;/BaseOutputPath&gt;
    &lt;BaseIntermediateOutputPath&gt;$(BaseOutputPath)\obj&lt;/BaseIntermediateOutputPath&gt;
  &lt;/PropertyGroup&gt;
&lt;/Project&gt;

</code></pre>
<p>Notice the use of <em>MSBuildThisFileDirectory</em> in the base path, that allows us to define the path relative to the property file.</p>

<p><code class="language-plaintext highlighter-rouge">Directory.Build.targets</code> is where we set project and configuration specific paths:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;Project</span> <span class="na">xmlns=</span><span class="s">"http://schemas.microsoft.com/developer/msbuild/2003"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;PropertyGroup&gt;</span>
    <span class="nt">&lt;OutputPath&gt;</span>$(BaseOutputPath)\$(AssemblyName)\bin\$(Configuration)<span class="nt">&lt;/OutputPath&gt;</span>
    <span class="nt">&lt;IntermediateOutputPath&gt;</span>$(BaseIntermediateOutputPath)$(AssemblyName)\obj\$(Configuration)<span class="nt">&lt;/IntermediateOutputPath&gt;</span>
  <span class="nt">&lt;/PropertyGroup&gt;</span>
<span class="nt">&lt;/Project&gt;</span>
</code></pre></div></div>

<p>And we’re done. There is though one catch, especially if you have a lot of .NET framework projects that do not make use of the SDK simplifications.</p>

<p>You need to remove any <em>OutputPath</em> definitions in conditional entries (usually the <em>Condition=”’$(Configuration)|$(Platform)’==’Debug|AnyCPU’”</em> and <em>Condition=”’$(Configuration)|$(Platform)’==’Release|AnyCPU’”</em> entries.
Visual Studio does not expose <em>IntermediateOutputPath</em> in the GUI so you will not see an entry unless you add it.</p>

<p>You also need to be aware that when editing properties in Visual Studio the values are changed in the project files, which will overrided any entries in the Directory.Build files.</p>

<h2 id="out-of-band-builds-ftw">Out of band builds ftw!</h2>

<p><code class="language-plaintext highlighter-rouge">out/</code> should be the only entry in .gitignore.</p>

<p>This setup will force msbuild, dotnet and VS to at least compile everything in <code class="language-plaintext highlighter-rouge">out/build</code> and stop littering the workspace.</p>
</div>

<div class="commentbox"></div>
<script src="https://unpkg.com/commentbox.io/dist/commentBox.min.js"></script>
<script>
  commentBox("5724844746342400-proj");
</script>

<noscript>Please enable JavaScript to view comments </noscript>


      <div class="footer">
        <div class="contact">
          <p>
            Vassilis Rizopoulos<br />
            Itinerant software engineer<br />
          </p>
        </div>
        <div class="contact">
          <p>
            <a href="http://github.com/damphyr">github.com/damphyr</a><br />
            <a href="http://twitter.com/arcandros">twitter.com/arcandros</a><br />
          </p>
        </div>
      </div>
    </div>
  </div>
</body>

</html>